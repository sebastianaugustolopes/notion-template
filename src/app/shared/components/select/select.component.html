<div class="w-full space-y-2">
  <!-- Label -->
  <label *ngIf="label" class="block text-sm font-semibold text-white mb-2 tracking-wide">
    {{ label }}
    <span *ngIf="required" class="text-rose-400 ml-1 animate-pulse">*</span>
  </label>

  <!-- Select Root Container -->
  <div #selectContainer class="relative w-full app-select-root">
    <!-- Normal Mode -->
    <ng-container *ngIf="!isCompact(); else compactMode">
      <button #toggleBtn type="button" (click)="toggleOpen()" [class.ring-2]="open" [class.ring-indigo-500/50]="open"
        [class.border-indigo-500]="open" [class.shadow-xl]="open" [class.shadow-indigo-500/20]="open"
        [class.border-rose-500]="errorMsg" [class.ring-rose-500/30]="errorMsg && open" class="group relative w-full flex items-center justify-between px-4 py-3.5 
               bg-linear-to-br from-neutral-800/90 to-neutral-900/90 
               border-2 border-neutral-700/80 rounded-xl text-white 
               hover:border-neutral-600 hover:shadow-lg hover:shadow-neutral-900/30
               focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500
               transition-all duration-300 ease-out backdrop-blur-sm
               overflow-hidden">

        <!-- Animated Background Gradient -->
        <div class="absolute inset-0 bg-linear-to-r from-indigo-600/0 via-indigo-600/5 to-indigo-600/0 
                    -translate-x-full group-hover:translate-x-full transition-transform duration-700 ease-in-out">
        </div>

        <!-- Selected Content -->
        <div class="relative flex items-center gap-3 flex-1 min-w-0 z-10">
          <ng-container *ngIf="getSelectedOption() as selected; else placeholderTpl">
            <!-- Icon -->
            <div *ngIf="selected.icon"
              class="w-9 h-9 flex items-center justify-center rounded-lg shadow-lg transition-all duration-300 group-hover:scale-110 group-hover:rotate-3 shrink-0"
              [ngClass]="getIconColorClasses(selected.iconColor)">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" [attr.d]="selected.icon" />
              </svg>
            </div>

            <!-- Color Dot -->
            <div *ngIf="selected.bgColor && !selected.icon" class="w-8 h-8 flex items-center justify-center rounded-lg bg-neutral-800/50 backdrop-blur-sm shrink-0 
                        transition-all duration-300 group-hover:scale-110">
              <span class="w-4 h-4 rounded-full shadow-lg transition-transform duration-300 group-hover:scale-110"
                [ngClass]="selected.bgColor"></span>
            </div>

            <!-- Label & Description -->
            <div class="flex flex-row min-w-0 flex-1">
              <span class="text-sm font-semibold text-white truncate">{{ selected.label }}</span>
              <span *ngIf="selected.description" class="text-xs text-neutral-400 truncate mt-0.5">
                {{ selected.description }}
              </span>
            </div>
          </ng-container>

          <ng-template #placeholderTpl>
            <span class="text-sm text-neutral-400 font-medium">{{ placeholder }}</span>
          </ng-template>
        </div>

        <!-- Chevron with Glow Effect -->
        <div class="relative ml-2 z-10">
          <svg class="relative w-5 h-5 text-neutral-400 group-hover:text-neutral-200 
                   transition-all duration-300 ease-out" [class.rotate-180]="open" [class.text-indigo-400]="open"
            fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7" />
          </svg>
        </div>
      </button>
    </ng-container>

    <!-- Compact Mode -->
    <ng-template #compactMode>
      <button #toggleBtn type="button" (click)="toggleOpen()" [class.ring-2]="open" [class.ring-indigo-500/50]="open"
        [class.border-indigo-500]="open" [class.shadow-lg]="open" class="group relative w-full flex items-center justify-between px-3 py-2.5 
               bg-linear-to-br from-neutral-800/90 to-neutral-900/90 
               border-2 border-neutral-700/80 rounded-lg text-white 
               hover:border-neutral-600 hover:shadow-md
               focus:outline-none focus:ring-2 focus:ring-indigo-500/50
               transition-all duration-200 backdrop-blur-sm overflow-hidden">

        <!-- Selected Content -->
        <div class="relative flex items-center gap-2 flex-1 min-w-0 z-10">
          <ng-container *ngIf="getSelectedOption() as selected; else placeholderTpl">
            <span class="text-sm font-medium text-white truncate">{{ selected.label }}</span>
          </ng-container>
          <ng-template #placeholderTpl>
            <span class="text-sm text-neutral-400 font-medium truncate">{{ placeholder }}</span>
          </ng-template>
        </div>

        <!-- Chevron -->
        <div class="relative ml-2 z-10 shrink-0">
          <svg class="relative w-4 h-4 text-neutral-400 group-hover:text-neutral-200 
                   transition-all duration-200" [class.rotate-180]="open" [class.text-indigo-400]="open" fill="none"
            stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7" />
          </svg>
        </div>
      </button>
    </ng-template>

    <!-- Dropdown Overlay - Inside relative container -->
    <div *ngIf="open" class="app-select-overlay absolute z-200
             bg-linear-to-br from-neutral-900/98 to-neutral-950/98 
             backdrop-blur-xl border-2 border-neutral-700/80 
             rounded-xl shadow-2xl shadow-black/50
             overflow-hidden animate-dropdown-appear
             left-0 top-full mt-2" [ngClass]="{
        'w-full': !isCompact(),
        'min-w-48': isCompact()
      }">

      <!-- Search Bar -->
      <div *ngIf="isSearchable()" class="relative p-3 border-b border-neutral-800/80 bg-neutral-900/50">
        <div class="relative">
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-500 pointer-events-none" fill="none"
            stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input #searchInput type="text" class="app-select-search w-full pl-10 pr-4 py-2.5 
               bg-neutral-800/80 border border-neutral-700/50 rounded-lg 
               text-white text-sm placeholder-neutral-500
               focus:outline-none focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500
               transition-all duration-200" placeholder="Buscar opções..." [value]="searchTerm"
            (input)="onSearchInput($event)" (click)="$event.stopPropagation()">
        </div>
      </div>

      <!-- Options List -->
      <div class="py-2 max-h-80 overflow-y-auto scrollbar-hide">
        <ng-container *ngIf="getFilteredOptions().length > 0; else noResults">
          <button *ngFor="let option of getFilteredOptions(); let i = index" type="button"
            (click)="onSelect(option.value)" (mouseenter)="onMouseEnterOption(i)"
            [class.border-l-4]="option.value === value" [class.border-l-indigo-500]="option.value === value"
            [style.animation-delay]="i * 30 + 'ms'" class="group/item w-full text-left px-4 py-3 
               flex items-center gap-3 text-neutral-300
               hover:bg-neutral-800/40
               active:scale-[0.98]
               transition-all duration-200 ease-out
               animate-slide-in opacity-0
               border-l-4 border-l-transparent
               relative overflow-hidden">

            <!-- Icon -->
            <div *ngIf="option.icon" class="relative w-9 h-9 flex items-center justify-center rounded-lg shadow-lg 
                    transition-all duration-300 shrink-0
                    group-hover/item:scale-110 z-10" [ngClass]="getIconColorClasses(option.iconColor)">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" [attr.d]="option.icon" />
              </svg>
            </div>

            <!-- Color Dot -->
            <div *ngIf="option.bgColor && !option.icon" class="relative w-8 h-8 flex items-center justify-center rounded-lg 
                    bg-neutral-800/50 backdrop-blur-sm shrink-0
                    transition-all duration-300 group-hover/item:scale-110 z-10">
              <span class="w-4 h-4 rounded-full shadow-lg 
                       transition-transform duration-300 group-hover/item:scale-110" [ngClass]="option.bgColor"></span>
            </div>

            <!-- Content -->
            <div class="relative flex-1 min-w-0 z-10">
              <div class="flex flex-col gap-0.5">
                <span class="text-sm font-semibold truncate 
                         text-neutral-200 group-hover/item:text-white
                         transition-colors duration-200">
                  {{ option.label }}
                </span>
                <span *ngIf="option.description" class="text-xs text-neutral-500 truncate
                         group-hover/item:text-neutral-400 transition-colors duration-200">
                  {{ option.description }}
                </span>
              </div>
            </div>

            <!-- Check Mark -->
            <div *ngIf="option.value === value" class="relative w-7 h-7 flex items-center justify-center rounded-lg 
                    bg-linear-to-br from-emerald-500 to-teal-600 
                    shadow-lg shadow-emerald-500/50 shrink-0
                    animate-check-bounce z-10">
              <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                  d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                  clip-rule="evenodd" />
              </svg>
            </div>
          </button>
        </ng-container>

        <!-- No Results -->
        <ng-template #noResults>
          <div class="flex flex-col items-center justify-center py-12 px-4 text-neutral-500">
            <svg class="w-16 h-16 mb-4 opacity-40 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span class="text-sm font-medium">Nenhum resultado encontrado</span>
            <span class="text-xs mt-1">Tente outro termo de busca</span>
          </div>
        </ng-template>
      </div>
    </div>

    <!-- Error Message -->
    <div *ngIf="errorMsg" class="flex items-center gap-2 px-3.5 py-2.5 
           bg-linear-to-r from-rose-500/10 to-red-500/10 
           border border-rose-500/30 rounded-lg
           text-rose-400 text-xs font-medium
           animate-shake" role="alert" aria-live="polite">
      <div class="w-5 h-5 flex items-center justify-center rounded-lg 
                bg-linear-to-br from-rose-500 to-red-600 
                shadow-lg shadow-rose-500/40 shrink-0 animate-pulse">
        <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd"
            d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
            clip-rule="evenodd" />
        </svg>
      </div>
      <span>{{ errorMsg }}</span>
    </div>
  </div>